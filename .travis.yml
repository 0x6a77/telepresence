sudo: false

services:
  - docker

# Cache gcloud SDK across runs:
cache:
  directories:
    - "$HOME/google-cloud-sdk/"

env:
  global:
    - PROJECT_NAME=datawire
    - CLUSTER_NAME=telepresence-testing
    - CLOUDSDK_COMPUTE_ZONE=us-central-1a

before_install:
  # Decrypt the service key:
  - openssl aes-256-cbc -K $encrypted_6168b41c1bb0_key -iv $encrypted_6168b41c1bb0_iv -in gcloud-service-key.json.enc -out gcloud-service-key.json -d
  # Make sure gcloud is installed:
  - ./ci/setup-gcloud.sh

install:
  # Push Docker images to Google Container Registry:
  - ./ci/push-images.sh
  # Build Docker images
  - make build
  # Push Docker images to 
  - 
script:
  - env TELEPRESENCE_VERSION=${make version} \
        TELEPRESENCE_REGISTRY=gcr.io/${PROJECT_NAME} \
        ./ci/test.sh
